name: Homebrew Bump

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 3 * * *" # daily at 03:00 UTC

jobs:
  bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Install Homebrew if missing
        run: |
          if ! /home/linuxbrew/.linuxbrew/bin/brew --version >/dev/null 2>&1; then
            echo "Homebrew not found, installing..."
            NONINTERACTIVE=1 /bin/bash -c \
              "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          else
            echo "Homebrew already installed"
          fi

          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew tap --force "${{ github.repository }}"

          {
            echo "HOMEBREW_PREFIX=$HOMEBREW_PREFIX"
            echo "HOMEBREW_CELLAR=$HOMEBREW_CELLAR"
            echo "HOMEBREW_REPOSITORY=$HOMEBREW_REPOSITORY"
            echo "PATH=$PATH"
            echo "MANPATH=$MANPATH"
            echo "INFOPATH=$INFOPATH"
          } >> "$GITHUB_ENV"

      - name: Configure git
        uses: Homebrew/actions/git-user-config@main
        with:
          username: lambdaclan

      - name: Bump packages
        id: bump
        continue-on-error: true
        env:
          HOMEBREW_DEVELOPER: 1
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          brew bump --tap ${{ github.repository }} --open-pr --no-fork 2>&1 | tee bump_output.log

      - name: Create issues for failed audits
        if: steps.bump.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Parse the bump output for audit failures
          if grep -q "brew audit.*failed" bump_output.log; then
            # Extract formula names that failed audit
            grep -B 5 "brew audit.*failed" bump_output.log | grep "^==>" | sed 's/.*==>\s*\[\?1m\?\(.*\)\[\?0m.*/\1/' | while read -r formula; do
              # Skip empty lines
              [ -z "$formula" ] && continue
              
              # Extract the error details for this formula
              error_details=$(awk "/==> .*${formula}/,/brew audit.*failed/" bump_output.log | grep "^\s*\*" || echo "No specific error details found")
              
              # Check if an issue already exists for this formula
              existing_issue=$(gh issue list --repo ${{ github.repository }} --state open --search "in:title brew audit failed: ${formula}" --json number --jq '.[0].number')
              
              if [ -z "$existing_issue" ]; then
                gh issue create \
                  --repo ${{ github.repository }} \
                  --title "brew audit failed: ${formula}" \
                  --label "audit-failure,automated" \
                  --body "## Audit Failure for \`${formula}\`

              The automated bump workflow detected that \`brew audit\` failed for this formula.

              ### Error Details:
              \`\`\`
              ${error_details}
              \`\`\`

              ### Workflow Run:
              ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

              This issue was automatically created by the bump workflow. Please review and fix the formula dependencies or configuration."
                              
                              echo "Created issue for ${formula}"
                            else
                              echo "Issue already exists for ${formula}: #${existing_issue}"
                            fi
                          done
                        fi
